<div class="allot-root">
  <div class="header">
    <h3>Allotment - {{ currentMonthShortName }} {{ currentYear }}</h3>
    <div class="income-info">
        <label class="available">
      <span class="material-icons icon-inline" style="margin-bottom: 5px;">account_balance_wallet </span><span style="margin-bottom: 5px;"> {{ availableIncome }}</span>
      </label>
      <label class="remaining">
      <span class="material-icons icon-inline">currency_rupee</span>
      <span [ngClass]="{ 'over': remainingIncome < 0, 'normal': remainingIncome >= 0 }">
         {{ remainingIncome }}
      </span>
        </label>
    </div>
   <div class="pagination">
  <button class="nav-btn" [disabled]="!hasPrev" (click)="goPrev()">
    <span class="material-icons">arrow_back_ios</span>
  </button>
  <div class="month-label">{{ currentMonthShortName }} {{ currentYear }}</div>
  <button class="nav-btn" [disabled]="!hasNext" (click)="goNext()">
    <span class="material-icons">arrow_forward_ios</span>
  </button>
</div>

  </div>

  <div class="grid">
    <!-- Header row -->
    <div class="grid-header">
      <div>Category</div>
      <div>Spent</div>
      <div>Allotted</div>
    </div>

    <!-- Data rows -->
    <div class="grid-item" *ngFor="let a of allotments">
      
      <!-- View mode -->
      <div *ngIf="editId !== a.category_id" class="row">
        <div class="col category">
            <span *ngIf="a.category_type=='expense'" class="material-icons icon-inline">receipt_long</span> 
            <span *ngIf="a.category_type=='savings'" class="material-icons icon-inline">savings</span> 
            {{ a.category }}</div>
        <div class="col spent">
          <span class="amount">₹{{ a.amountSpent }}</span>
          <div class="progress-bar">
            <div class="progress" 
                 [style.width.%]="(a.amountSpent / a.amountAllotted) * 100"
                 [class.over]="a.amountSpent > a.amountAllotted"></div>
          </div>
        </div>
        <div class="col allotted">
          <span class="amount">₹{{ a.amountAllotted }}</span>
          <button class="icon-btn" *ngIf="canEdit" (click)="startEdit(a)">
            <span class="material-icons">edit</span>
          </button>
        </div>
      </div>

      <!-- Edit mode -->
      <div *ngIf="editId === a.category_id" class="edit-row">
        <div class="col category">{{ a.category }}</div>
        <div class="col spent">
          <span class="amount">₹{{ a.amountSpent }}</span>
          <div class="progress-bar">
            <div class="progress" 
                 [style.width.%]="(a.amountSpent / tempAmounts[a.category_id]) * 100"
                 [class.over]="a.amountSpent > tempAmounts[a.category_id]"></div>
          </div>
        </div>
        <div class="col allotted">
          <input type="number" [(ngModel)]="tempAmounts[a.category_id]"  (ngModelChange)="onEditAmountChange($event,a)"/>
          <div class="edit-actions">
            <button mat-icon-button color="primary" class="icon-btn" (click)="saveEdit(a)"><span class="material-icons">check</span></button>
            <button mat-icon-button class="icon-btn" (click)="cancelEdit()">
              <span class="material-icons">close</span></button>
          </div>
        </div>
      </div>
    </div>
     <!-- + Add Category Row -->
<div class="grid-item add-category-row" *ngIf="canEdit && showCategoryAddRow">
  <div class="row align-center">
    <div class="col category compact">
      <mat-form-field appearance="outline" class="dark-select small-select" hideRequiredMarker>
        <mat-label>Select or Add Category</mat-label>
        <mat-select [(value)]="selectedCategoryId" panelClass="dark-select-panel">
          <mat-option (click)="openAddCategoryPopup()">➕ Add New Category</mat-option>
          <mat-option *ngFor="let c of filteredCategories" [value]="c.id">
            {{ c.category_name }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <button mat-icon-button color="primary" class="icon-btn save-btn" (click)="addSelectedCategory()">
        <mat-icon>check</mat-icon>
      </button>

      <button mat-icon-button color="warn" class="icon-btn cancel-btn" (click)="toggleAddCategoryRow()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>
</div>
<app-category-add-popup
  *ngIf="showAddCatagoryPopup"
  (close)="handlePopupClose()"
  (categoryAdded)="handleCategoryAdded($event)">
</app-category-add-popup>

    <!-- Footer row -->
    <div class="grid-footer">
      <div>Total</div>
      <div>₹{{ totalSpent }}</div>
      <div>₹{{ totalAllotted }}</div>
    </div>
   <div class="col category" *ngIf="!showCategoryAddRow">
      <a (click)="toggleAddCategoryRow()" class="add-category-link">+ Add Category</a>
    </div>
 
  <!-- Floating Add button -->
  <!-- <button *ngIf="canEdit" class="fab" (click)="openPopup()">
    <span class="material-icons">add</span>
  </button> -->

  <!-- Popup for new allotments -->
  <div class="popup-backdrop" *ngIf="showAddPopup" (click)="closePopup()">
    <div class="popup" (click)="$event.stopPropagation()">
      <h4>New Allotment</h4>
      <form (ngSubmit)="addAllotment()">
          <div class="income-info" style="margin-bottom: 10px;">
          
          <label class="available">
      <span class="material-icons" style="margin-bottom: 5px;">account_balance_wallet </span><span style="margin-bottom: 5px;"> {{ availableIncome - totalAllotted }}</span>
      </label>
      <label class="remaining">
      <span class="material-icons">currency_rupee</span>
      <span [ngClass]="{ 'remaining': remainingIncome >= 0, 'over': remainingIncome < 0 }">
         ₹{{ remainingIncome }}
      </span>
        </label>
           
        </div>
        <div class="popup-grid">
          <div class="popup-row" *ngFor="let c of allotments">
            
            <span *ngIf="!c.amountAllotted">{{ c.category }}</span>
            <input type="number" *ngIf="!c.amountAllotted"
                   [(ngModel)]="popupAllotments[c.category_id]"
                   name="amount-{{c.category_id}}"
                   min="0"
                   placeholder="₹0" (ngModelChange)="onAllotmentChange()"/>
                   
          </div>
        </div>

        <div class="popup-actions">
          <button type="button" class="btn secondary" (click)="closePopup()">Cancel</button>
          <button type="submit" class="btn primary">Save</button>
        </div>
      </form>

      <!-- Validation message -->
      <div class="error" *ngIf="errorMessage">{{ errorMessage }}</div>
    </div>
  </div>
</div>
